<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Finance Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=IBM+Plex+Mono:wght@400;500&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --bg-primary: #0a0e12;
            --bg-secondary: #141920;
            --bg-tertiary: #1e2530;
            --accent-gold: #d4af37;
            --accent-green: #4ade80;
            --accent-red: #ef4444;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border-color: #2d3748;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, #0f1419 100%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .grain-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.03'/%3E%3C/svg%3E");
            pointer-events: none;
            z-index: 1000;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
            position: relative;
            z-index: 1;
        }

        header {
            text-align: center;
            margin-bottom: 60px;
            position: relative;
        }

        h1 {
            font-family: 'Playfair Display', serif;
            font-size: 3.5rem;
            font-weight: 700;
            color: var(--accent-gold);
            margin-bottom: 10px;
            text-shadow: 0 4px 20px rgba(212, 175, 55, 0.3);
            letter-spacing: -0.02em;
        }

        .subtitle {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.9rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.15em;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 40px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0;
        }

        .tab {
            font-family: 'IBM Plex Mono', monospace;
            padding: 15px 30px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            position: relative;
        }

        .tab:hover {
            color: var(--text-primary);
            background: rgba(212, 175, 55, 0.05);
        }

        .tab.active {
            color: var(--accent-gold);
            border-bottom-color: var(--accent-gold);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
            border-color: rgba(212, 175, 55, 0.3);
        }

        .card h2 {
            font-family: 'Playfair Display', serif;
            font-size: 1.8rem;
            margin-bottom: 20px;
            color: var(--accent-gold);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 25px;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            background: rgba(212, 175, 55, 0.05);
            border-color: var(--accent-gold);
        }

        .stat-label {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .stat-value {
            font-family: 'Playfair Display', serif;
            font-size: 2rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .stat-change {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stat-change.positive { color: var(--accent-green); }
        .stat-change.negative { color: var(--accent-red); }

        .chart-container {
            position: relative;
            height: 400px;
            margin-top: 20px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            font-family: 'IBM Plex Mono', monospace;
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        input, select {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
        }

        button {
            font-family: 'IBM Plex Mono', monospace;
            padding: 14px 32px;
            background: var(--accent-gold);
            color: var(--bg-primary);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
        }

        button:hover {
            background: #ecc84f;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(212, 175, 55, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .accounts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .account-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            display: grid;
            grid-template-columns: 1fr auto auto auto;
            gap: 10px;
            align-items: center;
            transition: all 0.2s ease;
        }

        .account-item:hover {
            background: rgba(212, 175, 55, 0.05);
            border-color: var(--accent-gold);
        }

        .account-name {
            font-weight: 500;
            color: var(--text-primary);
        }

        .account-input {
            width: 100px;
            padding: 6px 10px;
            font-size: 0.9rem;
        }

        .account-currency {
            width: 80px;
            padding: 6px 10px;
            font-size: 0.9rem;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .spinner {
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--accent-gold);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .import-section {
            background: var(--bg-tertiary);
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }

        .import-section:hover {
            border-color: var(--accent-gold);
            background: rgba(212, 175, 55, 0.02);
        }

        .import-section input[type="file"] {
            display: none;
        }

        .import-label {
            display: inline-block;
            padding: 14px 32px;
            background: var(--bg-secondary);
            border: 1px solid var(--accent-gold);
            color: var(--accent-gold);
            border-radius: 8px;
            cursor: pointer;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            transition: all 0.3s ease;
        }

        .import-label:hover {
            background: var(--accent-gold);
            color: var(--bg-primary);
        }

        .success-message {
            background: rgba(74, 222, 128, 0.1);
            border: 1px solid var(--accent-green);
            color: var(--accent-green);
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
            font-family: 'IBM Plex Mono', monospace;
        }

        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--accent-red);
            color: var(--accent-red);
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
            font-family: 'IBM Plex Mono', monospace;
        }

        @media (max-width: 768px) {
            h1 { font-size: 2.5rem; }
            .tabs { overflow-x: auto; }
            .tab { padding: 12px 20px; }
            .stats-grid { grid-template-columns: 1fr; }
            .accounts-grid { grid-template-columns: 1fr; }
            .account-item { grid-template-columns: 1fr; }
        }

        /* Historical table styles */
        #history-table {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.85rem;
        }

        #history-table th {
            background: var(--bg-tertiary);
            color: var(--accent-gold);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 0.75rem;
            border-bottom: 2px solid var(--border-color);
            position: sticky;
            top: 0;
        }

        #history-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        #history-table tr:hover {
            background: rgba(212, 175, 55, 0.05);
        }

        #history-table .currency-badge {
            display: inline-block;
            padding: 2px 8px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-left: 5px;
        }

        /* Details table styles */
        #details-table {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.85rem;
        }

        #details-table th {
            background: var(--bg-tertiary);
            color: var(--accent-gold);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 0.75rem;
            border-bottom: 2px solid var(--border-color);
            position: sticky;
            top: 0;
            cursor: pointer;
            user-select: none;
        }

        #details-table th:hover {
            background: rgba(212, 175, 55, 0.1);
        }

        #details-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        #details-table tr:hover {
            background: rgba(212, 175, 55, 0.05);
        }

        #details-table .category-cell {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        #details-table .amount-cell {
            text-align: right;
            font-weight: 500;
        }

        #details-table .gbp-cell {
            text-align: right;
            color: var(--accent-gold);
            font-weight: 600;
        }

        #details-table .currency-cell {
            text-align: center;
            color: var(--text-muted);
        }

        .category-row {
            background: rgba(212, 175, 55, 0.05);
            font-weight: 600;
            color: var(--accent-gold);
        }

        /* Entry table styles */
        .entry-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            margin-bottom: 25px;
        }

        .entry-table th {
            background: var(--bg-tertiary);
            color: var(--accent-gold);
            padding: 10px;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 0.75rem;
            border-bottom: 2px solid var(--border-color);
        }

        .entry-table td {
            padding: 8px 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .entry-table tr:hover {
            background: rgba(212, 175, 55, 0.05);
        }

        .entry-table input[type="number"] {
            width: 100%;
            padding: 6px 10px;
            font-size: 0.85rem;
            min-width: 100px;
        }

        .entry-table select {
            width: 100%;
            padding: 6px 10px;
            font-size: 0.85rem;
            min-width: 80px;
        }

        .entry-category-header {
            background: rgba(212, 175, 55, 0.1);
            font-weight: 600;
            color: var(--accent-gold);
            padding: 12px 10px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-size: 0.8rem;
            border-top: 2px solid var(--accent-gold);
            border-bottom: 1px solid var(--border-color);
        }

        /* Chat styles */
        .chat-message {
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 15px;
            animation: fadeIn 0.3s ease;
        }

        .chat-message.user {
            background: rgba(212, 175, 55, 0.1);
            border-left: 3px solid var(--accent-gold);
        }

        .chat-message.ai {
            background: var(--bg-secondary);
            border-left: 3px solid var(--accent-green);
        }

        .chat-message .sender {
            font-size: 0.75rem;
            color: var(--accent-gold);
            text-transform: uppercase;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .chat-message.ai .sender {
            color: var(--accent-green);
        }

        .chat-message .content {
            color: var(--text-primary);
            line-height: 1.6;
        }

        .chat-loading {
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 15px;
            color: var(--text-secondary);
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="grain-overlay"></div>
    <div class="container">
        <header>
            <h1>Financial Portfolio</h1>
            <div class="subtitle">Multi-Currency Asset Tracker</div>
        </header>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('dashboard')">Dashboard</button>
            <button class="tab" onclick="switchTab('details')">Details</button>
            <button class="tab" onclick="switchTab('add-entry')">Add Entry</button>
            <button class="tab" onclick="switchTab('accounts')">Manage Accounts</button>
            <button class="tab" onclick="switchTab('ai-analysis')">AI Analysis</button>
            <button class="tab" onclick="switchTab('data')">Import/Export</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Net Worth <span id="networth-date" style="font-weight: 400; opacity: 0.7;"></span></div>
                    <div class="stat-value" id="total-networth">£0</div>
                    <div class="stat-change" id="networth-change">
                        <span>—</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Assets <span id="assets-date" style="font-weight: 400; opacity: 0.7;"></span></div>
                    <div class="stat-value" id="total-assets">£0</div>
                    <div class="stat-change" id="assets-change">
                        <span>—</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Savings Rate</div>
                    <div class="stat-value" id="savings-rate">—</div>
                    <div class="stat-change">
                        <span id="savings-rate-date">Last month</span>
                    </div>
                </div>
            </div>
            
            <div style="text-align: center; margin: -10px 0 30px 0; opacity: 0.5;">
                <small style="font-family: 'IBM Plex Mono', monospace; font-size: 0.7rem; color: var(--text-muted);">
                    Last updated: <span id="last-updated">—</span>
                </small>
            </div>

            <div class="card">
                <h2>Net Worth Over Time</h2>
                <div class="chart-container">
                    <canvas id="networth-chart"></canvas>
                </div>
            </div>

            <div class="card">
                <h2>Asset Allocation</h2>
                <div class="chart-container" style="height: 350px;">
                    <canvas id="allocation-chart"></canvas>
                </div>
            </div>

            <div class="card">
                <h2>Savings Rate Trend</h2>
                <div class="chart-container">
                    <canvas id="savings-chart"></canvas>
                </div>
            </div>

            <div class="card">
                <h2>Historical Data</h2>
                <div style="overflow-x: auto;">
                    <table id="history-table" style="width: 100%; border-collapse: collapse;">
                        <!-- Populated dynamically -->
                    </table>
                </div>
            </div>

            <div class="card">
                <h2>Account Balance History</h2>
                <div class="form-group">
                    <label for="account-select">Select Account</label>
                    <select id="account-select" onchange="drawAccountHistory()">
                        <option value="">-- Select an account --</option>
                    </select>
                </div>
                <div class="chart-container" id="account-history-container" style="display: none;">
                    <canvas id="account-history-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- Details Tab -->
        <div id="details" class="tab-content">
            <div class="card">
                <h2>Complete Financial Data</h2>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">
                    All account balances in original currencies with GBP equivalents. Click column headers to sort.
                </p>
                
                <div style="margin-bottom: 20px;">
                    <label for="details-month-select">Select Month:</label>
                    <select id="details-month-select" onchange="updateDetailsTable()" style="width: auto; display: inline-block; margin-left: 10px;">
                        <!-- Populated dynamically -->
                    </select>
                </div>

                <div style="overflow-x: auto;">
                    <table id="details-table" style="width: 100%; border-collapse: collapse; font-family: 'IBM Plex Mono', monospace; font-size: 0.85rem;">
                        <!-- Populated dynamically -->
                    </table>
                </div>

                <div style="margin-top: 30px; padding: 20px; background: var(--bg-tertiary); border-radius: 8px;">
                    <h3 style="font-family: 'IBM Plex Mono', monospace; color: var(--accent-gold); font-size: 1rem; margin-bottom: 15px;">Summary</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;" id="details-summary">
                        <!-- Populated dynamically -->
                    </div>
                </div>

                <div style="margin-top: 20px; text-align: center;">
                    <button onclick="exportDetailsToCSV()">Export to CSV</button>
                </div>
            </div>
        </div>

        <!-- Add Entry Tab -->
        <div id="add-entry" class="tab-content">
            <div class="card">
                <h2>Add Monthly Entry</h2>
                <div class="form-group">
                    <label for="entry-date">Date</label>
                    <input type="date" id="entry-date" required>
                </div>

                <!-- Pre-tax Income and Savings Calculation Section -->
                <div style="margin-bottom: 30px; padding: 20px; background: var(--bg-tertiary); border-radius: 8px; border: 1px solid var(--border-color);">
                    <h3 style="font-family: 'IBM Plex Mono', monospace; color: var(--accent-gold); font-size: 1rem; margin-bottom: 15px;">Income & Savings Rate</h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="pretax-income">Pre-Tax Monthly Income (GBP)</label>
                            <input type="number" id="pretax-income" placeholder="0.00" step="0.01" onchange="calculateSavingsRate()">
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="saved-amount">Total Saved This Month (GBP)</label>
                            <input type="number" id="saved-amount" placeholder="0.00" step="0.01" onchange="calculateSavingsRate()">
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div style="padding: 15px; background: var(--bg-secondary); border-radius: 6px;">
                            <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 5px;">Calculated Savings Rate</div>
                            <div id="calculated-savings-rate" style="font-size: 1.8rem; font-weight: 600; color: var(--accent-gold);">—</div>
                        </div>

                        <div style="padding: 15px; background: var(--bg-secondary); border-radius: 6px;">
                            <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 5px;">Net Worth Change</div>
                            <div id="networth-change-display" style="font-size: 1.8rem; font-weight: 600; color: var(--text-primary);">—</div>
                        </div>
                    </div>

                    <div style="margin-top: 15px; padding: 10px; background: rgba(212, 175, 55, 0.05); border-left: 3px solid var(--accent-gold); font-size: 0.85rem; color: var(--text-secondary);">
                        <strong>Tip:</strong> Savings Rate = (Total Saved ÷ Pre-Tax Income) × 100%
                    </div>
                </div>
                
                <div id="accounts-entry-list">
                    <!-- Populated dynamically with grouped accounts -->
                </div>

                <div style="margin-top: 30px; text-align: center;">
                    <button onclick="saveEntry()">Save Entry</button>
                </div>
                <div id="entry-message"></div>
            </div>
        </div>

        <!-- AI Analysis Tab -->
        <div id="ai-analysis" class="tab-content">
            <div class="card">
                <h2>AI Financial Analysis</h2>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">
                    Ask questions about your finances and get AI-powered insights based on your data.
                </p>

                <div id="chat-container" style="background: var(--bg-tertiary); border-radius: 8px; padding: 20px; min-height: 400px; max-height: 500px; overflow-y: auto; margin-bottom: 20px;">
                    <div id="chat-messages">
                        <div style="padding: 15px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 15px;">
                            <div style="font-size: 0.75rem; color: var(--accent-gold); text-transform: uppercase; margin-bottom: 5px;">AI Assistant</div>
                            <div style="color: var(--text-primary);">
                                Hello! I can help you analyze your financial data. Here are some questions you can ask:
                                <ul style="margin: 10px 0; padding-left: 20px;">
                                    <li>What's the major contributor to my net worth change this month?</li>
                                    <li>Which accounts have grown the most?</li>
                                    <li>What's my average savings rate?</li>
                                    <li>How has my asset allocation changed?</li>
                                    <li>Which category decreased the most?</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: 10px;">
                    <input type="text" id="chat-input" placeholder="Ask a question about your finances..." 
                           style="flex: 1;" onkeypress="if(event.key === 'Enter') sendChatMessage()">
                    <button onclick="sendChatMessage()" style="white-space: nowrap;">Send</button>
                </div>

                <div style="margin-top: 15px; padding: 10px; background: rgba(74, 222, 128, 0.1); border-left: 3px solid var(--accent-green); font-size: 0.85rem; color: var(--text-secondary);">
                    <strong>Note:</strong> The AI analyzes your data locally in your browser. No data is sent to external servers.
                </div>
            </div>
        </div>

        <!-- Manage Accounts Tab -->
        <div id="accounts" class="tab-content">
            <div class="card">
                <h2>Add New Account</h2>
                <div class="form-group">
                    <label for="account-name">Account Name</label>
                    <input type="text" id="account-name" placeholder="e.g., Chase Savings">
                </div>
                <div class="form-group">
                    <label for="account-category">Category</label>
                    <select id="account-category">
                        <option value="Savings">Savings</option>
                        <option value="Investment">Investment</option>
                        <option value="Property">Property</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="account-currency">Default Currency</label>
                    <select id="account-currency">
                        <option value="GBP">GBP</option>
                        <option value="USD">USD</option>
                        <option value="EUR">EUR</option>
                    </select>
                </div>
                <button onclick="addAccount()">Add Account</button>
                <div id="account-message"></div>
            </div>

            <div class="card">
                <h2>Your Accounts</h2>
                <div id="accounts-list">
                    <!-- Populated dynamically -->
                </div>
            </div>
        </div>

        <!-- Import/Export Tab -->
        <div id="data" class="tab-content">
            <div class="card">
                <h2>Import Data</h2>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">
                    Your existing spreadsheet data has been automatically imported. You can continue adding new entries or export your data.
                </p>
                <div class="import-section">
                    <p style="color: var(--text-secondary); margin-bottom: 15px;">
                        Import financial data from JSON file
                    </p>
                    <input type="file" id="import-file" accept=".json" onchange="importData(event)">
                    <label for="import-file" class="import-label">Choose File</label>
                </div>
                <div id="import-message"></div>
            </div>

            <div class="card">
                <h2>Export Data</h2>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">
                    Download your complete financial history as JSON
                </p>
                <button onclick="exportData()">Export to JSON</button>
            </div>

            <div class="card">
                <h2>Data Summary</h2>
                <div id="data-summary">
                    <!-- Populated dynamically -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize data storage with embedded historical data
        let financeData = {"accounts": [{"name": "Chase Dad's Credit Card", "category": "Cash & Savings"}, {"name": "Revolut Euro", "category": "Cash & Savings"}, {"name": "Revolut RMB", "category": "Cash & Savings"}, {"name": "Revolut Pound", "category": "Cash & Savings"}, {"name": "Revolut USD", "category": "Cash & Savings"}, {"name": "BoursoBank Euro", "category": "Cash & Savings"}, {"name": "TreasuryDirect", "category": "Cash & Savings"}, {"name": "Tandem saving", "category": "Cash & Savings"}, {"name": "Ally savings", "category": "Cash & Savings"}, {"name": "Revolut rainyday", "category": "Cash & Savings"}, {"name": "Moneybox Lifetime ISA", "category": "Investment Accounts"}, {"name": "Moneybox Cash ISA", "category": "Investment Accounts"}, {"name": "Amundi Plan Epargne Entreprise Euler Hermes", "category": "Investment Accounts"}, {"name": "Amundi Per Col", "category": "Retirement Accounts"}, {"name": "401K", "category": "Retirement Accounts"}, {"name": "Trading 212 ISA", "category": "Investment Accounts"}, {"name": "Fidelity Investment ISA", "category": "Investment Accounts"}, {"name": "Fidelity UK private pension", "category": "Retirement Accounts"}, {"name": "Royal London Pension", "category": "Retirement Accounts"}, {"name": "Bitcoin", "category": "Crypto"}, {"name": "The Laundry", "category": "Property"}, {"name": "Halifax mortgage", "category": "Liabilities"}], "historical_data": [{"date": "2024-08-01", "accounts": [{"name": "Chase Dad's Credit Card", "category": "Cash & Savings", "amount": 67704.46, "currency": "GBP", "gbp_amount": 67704.46}, {"name": "Revolut Euro", "category": "Cash & Savings", "amount": 476.0, "currency": "EUR", "gbp_amount": 406.8376068}, {"name": "TreasuryDirect", "category": "Cash & Savings", "amount": 5520.0, "currency": "USD", "gbp_amount": 4279.069767}, {"name": "Tandem saving", "category": "Cash & Savings", "amount": 1046.13, "currency": "GBP", "gbp_amount": 1046.13}, {"name": "Ally savings", "category": "Cash & Savings", "amount": 17014.22, "currency": "USD", "gbp_amount": 13189.31783}, {"name": "Moneybox Lifetime ISA", "category": "Investment Accounts", "amount": 8378.1, "currency": "GBP", "gbp_amount": 8378.1}, {"name": "Moneybox Cash ISA", "category": "Investment Accounts", "amount": 3123.1, "currency": "GBP", "gbp_amount": 3123.1}, {"name": "Amundi Plan Epargne Entreprise Euler Hermes", "category": "Investment Accounts", "amount": 18104.5, "currency": "EUR", "gbp_amount": 15473.93162}, {"name": "Amundi Per Col", "category": "Retirement Accounts", "amount": 5508.82, "currency": "EUR", "gbp_amount": 4708.393162}, {"name": "401K", "category": "Retirement Accounts", "amount": 52129.48, "currency": "USD", "gbp_amount": 40410.44961}, {"name": "Fidelity Investment ISA", "category": "Investment Accounts", "amount": 1883.64, "currency": "GBP", "gbp_amount": 1883.64}, {"name": "Fidelity UK private pension", "category": "Retirement Accounts", "amount": 24101.1, "currency": "GBP", "gbp_amount": 24101.1}, {"name": "The Laundry", "category": "Property", "amount": 849600.0, "currency": "GBP", "gbp_amount": 849600.0}, {"name": "Halifax mortgage", "category": "Liabilities", "amount": 380660.23, "currency": "GBP", "gbp_amount": 380660.23}], "total_networth": 653644.2996, "savings_rate": null}, {"date": "2024-09-01", "accounts": [{"name": "Chase Dad's Credit Card", "category": "Cash & Savings", "amount": 49210.06, "currency": "GBP", "gbp_amount": 49210.06}, {"name": "Revolut Euro", "category": "Cash & Savings", "amount": 456.77, "currency": "EUR", "gbp_amount": 383.8403361}, {"name": "TreasuryDirect", "category": "Cash & Savings", "amount": 5556.0, "currency": "USD", "gbp_amount": 4209.090909}, {"name": "Tandem saving", "category": "Cash & Savings", "amount": 1046.13, "currency": "GBP", "gbp_amount": 1046.13}, {"name": "Ally savings", "category": "Cash & Savings", "amount": 17014.22, "currency": "USD", "gbp_amount": 12889.56061}, {"name": "Moneybox Lifetime ISA", "category": "Investment Accounts", "amount": 8669.08, "currency": "GBP", "gbp_amount": 8669.08}, {"name": "Moneybox Cash ISA", "category": "Investment Accounts", "amount": 16883.13, "currency": "GBP", "gbp_amount": 16883.13}, {"name": "Amundi Plan Epargne Entreprise Euler Hermes", "category": "Investment Accounts", "amount": 18571.94, "currency": "EUR", "gbp_amount": 15606.67227}, {"name": "Amundi Per Col", "category": "Retirement Accounts", "amount": 5764.27, "currency": "EUR", "gbp_amount": 4843.92437}, {"name": "401K", "category": "Retirement Accounts", "amount": 53509.34, "currency": "USD", "gbp_amount": 40537.37879}, {"name": "Fidelity Investment ISA", "category": "Investment Accounts", "amount": 2095.11, "currency": "GBP", "gbp_amount": 2095.11}, {"name": "Fidelity UK private pension", "category": "Retirement Accounts", "amount": 26910.96, "currency": "GBP", "gbp_amount": 26910.96}, {"name": "The Laundry", "category": "Property", "amount": 849600.0, "currency": "GBP", "gbp_amount": 849600.0}, {"name": "Halifax mortgage", "category": "Liabilities", "amount": 379936.35, "currency": "GBP", "gbp_amount": 379936.35}], "total_networth": 652948.5873, "savings_rate": null}, {"date": "2024-10-01", "accounts": [{"name": "Chase Dad's Credit Card", "category": "Cash & Savings", "amount": 49210.06, "currency": "GBP", "gbp_amount": 49210.06}, {"name": "TreasuryDirect", "category": "Cash & Savings", "amount": 5556.0, "currency": "USD", "gbp_amount": 4273.846154}, {"name": "Tandem saving", "category": "Cash & Savings", "amount": 1046.13, "currency": "GBP", "gbp_amount": 1046.13}, {"name": "Ally savings", "category": "Cash & Savings", "amount": 15600.57, "currency": "USD", "gbp_amount": 12000.43846}, {"name": "Moneybox Lifetime ISA", "category": "Investment Accounts", "amount": 9036.17, "currency": "GBP", "gbp_amount": 9036.17}, {"name": "Moneybox Cash ISA", "category": "Investment Accounts", "amount": 17127.51, "currency": "GBP", "gbp_amount": 17127.51}, {"name": "Amundi Plan Epargne Entreprise Euler Hermes", "category": "Investment Accounts", "amount": 18510.95, "currency": "EUR", "gbp_amount": 15425.79167}, {"name": "Amundi Per Col", "category": "Retirement Accounts", "amount": 5793.78, "currency": "EUR", "gbp_amount": 4828.15}, {"name": "401K", "category": "Retirement Accounts", "amount": 54068.37, "currency": "USD", "gbp_amount": 41591.05385}, {"name": "Fidelity Investment ISA", "category": "Investment Accounts", "amount": 2359.33, "currency": "GBP", "gbp_amount": 2359.33}, {"name": "Fidelity UK private pension", "category": "Retirement Accounts", "amount": 28548.08, "currency": "GBP", "gbp_amount": 28548.08}, {"name": "The Laundry", "category": "Property", "amount": 849600.0, "currency": "GBP", "gbp_amount": 849600.0}, {"name": "Halifax mortgage", "category": "Liabilities", "amount": 379936.35, "currency": "GBP", "gbp_amount": 379936.35}], "total_networth": 655110.2101, "savings_rate": null}, {"date": "2025-01-01", "accounts": [{"name": "Chase Dad's Credit Card", "category": "Cash & Savings", "amount": 7164.03, "currency": "GBP", "gbp_amount": 7164.03}, {"name": "Revolut Pound", "category": "Cash & Savings", "amount": 299.83, "currency": "GBP", "gbp_amount": 299.83}, {"name": "Revolut USD", "category": "Cash & Savings", "amount": 0.67, "currency": "USD", "gbp_amount": 0.5491803279}, {"name": "TreasuryDirect", "category": "Cash & Savings", "amount": 5610.0, "currency": "USD", "gbp_amount": 4598.360656}, {"name": "Tandem saving", "category": "Cash & Savings", "amount": 1064.81, "currency": "GBP", "gbp_amount": 1064.81}, {"name": "Ally savings", "category": "Cash & Savings", "amount": 2534.89, "currency": "USD", "gbp_amount": 2077.778689}, {"name": "Revolut rainyday", "category": "Cash & Savings", "amount": 3199.05, "currency": "GBP", "gbp_amount": 3199.05}, {"name": "Moneybox Lifetime ISA", "category": "Investment Accounts", "amount": 9677.78, "currency": "GBP", "gbp_amount": 9677.78}, {"name": "Moneybox Cash ISA", "category": "Investment Accounts", "amount": 17293.0, "currency": "GBP", "gbp_amount": 17293.0}, {"name": "Amundi Plan Epargne Entreprise Euler Hermes", "category": "Investment Accounts", "amount": 18604.85, "currency": "EUR", "gbp_amount": 15634.32773}, {"name": "Amundi Per Col", "category": "Retirement Accounts", "amount": 5842.84, "currency": "EUR", "gbp_amount": 4909.94958}, {"name": "401K", "category": "Retirement Accounts", "amount": 54804.3, "currency": "USD", "gbp_amount": 44921.55738}, {"name": "Fidelity Investment ISA", "category": "Investment Accounts", "amount": 963.9, "currency": "GBP", "gbp_amount": 963.9}, {"name": "Fidelity UK private pension", "category": "Retirement Accounts", "amount": 40687.19, "currency": "GBP", "gbp_amount": 40687.19}, {"name": "Bitcoin", "category": "Crypto", "amount": 107.16, "currency": "GBP", "gbp_amount": 107.16}, {"name": "The Laundry", "category": "Property", "amount": 849600.0, "currency": "GBP", "gbp_amount": 849600.0}, {"name": "Halifax mortgage", "category": "Liabilities", "amount": 340797.46, "currency": "GBP", "gbp_amount": 340797.46}], "total_networth": 658202.7632, "savings_rate": null}, {"date": "2025-02-01", "accounts": [{"name": "Chase Dad's Credit Card", "category": "Cash & Savings", "amount": 5500.19, "currency": "GBP", "gbp_amount": 5500.19}, {"name": "Revolut Pound", "category": "Cash & Savings", "amount": 273.41, "currency": "GBP", "gbp_amount": 273.41}, {"name": "Revolut USD", "category": "Cash & Savings", "amount": 0.67, "currency": "USD", "gbp_amount": 0.5403225806}, {"name": "TreasuryDirect", "category": "Cash & Savings", "amount": 5624.0, "currency": "USD", "gbp_amount": 4535.483871}, {"name": "Tandem saving", "category": "Cash & Savings", "amount": 1064.81, "currency": "GBP", "gbp_amount": 1064.81}, {"name": "Ally savings", "category": "Cash & Savings", "amount": 2545.17, "currency": "USD", "gbp_amount": 2052.556452}, {"name": "Revolut rainyday", "category": "Cash & Savings", "amount": 3219.17, "currency": "GBP", "gbp_amount": 3219.17}, {"name": "Moneybox Lifetime ISA", "category": "Investment Accounts", "amount": 9842.51, "currency": "GBP", "gbp_amount": 9842.51}, {"name": "Moneybox Cash ISA", "category": "Investment Accounts", "amount": 17351.38, "currency": "GBP", "gbp_amount": 17351.38}, {"name": "Amundi Plan Epargne Entreprise Euler Hermes", "category": "Investment Accounts", "amount": 18953.43, "currency": "EUR", "gbp_amount": 15794.525}, {"name": "Amundi Per Col", "category": "Retirement Accounts", "amount": 5979.41, "currency": "EUR", "gbp_amount": 4982.841667}, {"name": "401K", "category": "Retirement Accounts", "amount": 56222.54, "currency": "USD", "gbp_amount": 45340.75806}, {"name": "Fidelity Investment ISA", "category": "Investment Accounts", "amount": 964.4, "currency": "GBP", "gbp_amount": 964.4}, {"name": "Fidelity UK private pension", "category": "Retirement Accounts", "amount": 42397.79, "currency": "GBP", "gbp_amount": 42397.79}, {"name": "Bitcoin", "category": "Crypto", "amount": 115.81, "currency": "GBP", "gbp_amount": 115.81}, {"name": "The Laundry", "category": "Property", "amount": 849600.0, "currency": "GBP", "gbp_amount": 849600.0}, {"name": "Halifax mortgage", "category": "Liabilities", "amount": 340316.42, "currency": "GBP", "gbp_amount": 340316.42}], "total_networth": 662719.7554, "savings_rate": null}, {"date": "2025-03-01", "accounts": [{"name": "Chase Dad's Credit Card", "category": "Cash & Savings", "amount": 3829.2, "currency": "GBP", "gbp_amount": 3829.2}, {"name": "Revolut Pound", "category": "Cash & Savings", "amount": 147.93, "currency": "GBP", "gbp_amount": 147.93}, {"name": "Revolut USD", "category": "Cash & Savings", "amount": 0.67, "currency": "USD", "gbp_amount": 0.519379845}, {"name": "TreasuryDirect", "category": "Cash & Savings", "amount": 5638.0, "currency": "USD", "gbp_amount": 4370.542636}, {"name": "Tandem saving", "category": "Cash & Savings", "amount": 1071.67, "currency": "GBP", "gbp_amount": 1071.67}, {"name": "Ally savings", "category": "Cash & Savings", "amount": 105.07, "currency": "USD", "gbp_amount": 81.4496124}, {"name": "Revolut rainyday", "category": "Cash & Savings", "amount": 2482.6, "currency": "GBP", "gbp_amount": 2482.6}, {"name": "Moneybox Lifetime ISA", "category": "Investment Accounts", "amount": 8625.95, "currency": "GBP", "gbp_amount": 8625.95}, {"name": "Moneybox Cash ISA", "category": "Investment Accounts", "amount": 17423.07, "currency": "GBP", "gbp_amount": 17423.07}, {"name": "Amundi Plan Epargne Entreprise Euler Hermes", "category": "Investment Accounts", "amount": 18955.44, "currency": "EUR", "gbp_amount": 15928.94118}, {"name": "Amundi Per Col", "category": "Retirement Accounts", "amount": 5797.23, "currency": "EUR", "gbp_amount": 4871.621849}, {"name": "401K", "category": "Retirement Accounts", "amount": 52313.92, "currency": "USD", "gbp_amount": 40553.42636}, {"name": "Fidelity Investment ISA", "category": "Investment Accounts", "amount": 1243.08, "currency": "GBP", "gbp_amount": 1243.08}, {"name": "Fidelity UK private pension", "category": "Retirement Accounts", "amount": 38919.02, "currency": "GBP", "gbp_amount": 38919.02}, {"name": "Bitcoin", "category": "Crypto", "amount": 137.22, "currency": "GBP", "gbp_amount": 137.22}, {"name": "The Laundry", "category": "Property", "amount": 849600.0, "currency": "GBP", "gbp_amount": 849600.0}, {"name": "Halifax mortgage", "category": "Liabilities", "amount": 339720.64, "currency": "GBP", "gbp_amount": 339720.64}], "total_networth": 649565.601, "savings_rate": null}, {"date": "2025-04-01", "accounts": [{"name": "Chase Dad's Credit Card", "category": "Cash & Savings", "amount": 2152.98, "currency": "GBP", "gbp_amount": 2152.98}, {"name": "Revolut Pound", "category": "Cash & Savings", "amount": 60.32, "currency": "GBP", "gbp_amount": 60.32}, {"name": "Revolut USD", "category": "Cash & Savings", "amount": 0.67, "currency": "USD", "gbp_amount": 0.5114503817}, {"name": "TreasuryDirect", "category": "Cash & Savings", "amount": 5652.0, "currency": "USD", "gbp_amount": 4314.503817}, {"name": "Tandem saving", "category": "Cash & Savings", "amount": 4287.41, "currency": "GBP", "gbp_amount": 4287.41}, {"name": "Ally savings", "category": "Cash & Savings", "amount": 105.36, "currency": "USD", "gbp_amount": 80.42748092}, {"name": "Moneybox Lifetime ISA", "category": "Investment Accounts", "amount": 8175.15, "currency": "GBP", "gbp_amount": 8175.15}, {"name": "Moneybox Cash ISA", "category": "Investment Accounts", "amount": 17478.17, "currency": "GBP", "gbp_amount": 17478.17}, {"name": "Amundi Plan Epargne Entreprise Euler Hermes", "category": "Investment Accounts", "amount": 18065.97, "currency": "EUR", "gbp_amount": 15709.53913}, {"name": "Amundi Per Col", "category": "Retirement Accounts", "amount": 5347.43, "currency": "EUR", "gbp_amount": 4649.93913}, {"name": "401K", "category": "Retirement Accounts", "amount": 50384.06, "currency": "USD", "gbp_amount": 38461.1145}, {"name": "Fidelity Investment ISA", "category": "Investment Accounts", "amount": 1403.11, "currency": "GBP", "gbp_amount": 1403.11}, {"name": "Fidelity UK private pension", "category": "Retirement Accounts", "amount": 38205.79, "currency": "GBP", "gbp_amount": 38205.79}, {"name": "Bitcoin", "category": "Crypto", "amount": 178.74, "currency": "GBP", "gbp_amount": 178.74}, {"name": "The Laundry", "category": "Property", "amount": 849600.0, "currency": "GBP", "gbp_amount": 849600.0}, {"name": "Halifax mortgage", "category": "Liabilities", "amount": 339239.08, "currency": "GBP", "gbp_amount": 339239.08}], "total_networth": 645518.6255, "savings_rate": null}, {"date": "2025-05-01", "accounts": [{"name": "Chase Dad's Credit Card", "category": "Cash & Savings", "amount": 5166.81, "currency": "GBP", "gbp_amount": 5166.81}, {"name": "Revolut Pound", "category": "Cash & Savings", "amount": 400.09, "currency": "GBP", "gbp_amount": 400.09}, {"name": "Revolut USD", "category": "Cash & Savings", "amount": 0.67, "currency": "USD", "gbp_amount": 0.5}, {"name": "TreasuryDirect", "category": "Cash & Savings", "amount": 5666.0, "currency": "USD", "gbp_amount": 4228.358209}, {"name": "Tandem saving", "category": "Cash & Savings", "amount": 4312.09, "currency": "GBP", "gbp_amount": 4312.09}, {"name": "Ally savings", "category": "Cash & Savings", "amount": 105.68, "currency": "USD", "gbp_amount": 78.86567164}, {"name": "Moneybox Lifetime ISA", "category": "Investment Accounts", "amount": 8958.03, "currency": "GBP", "gbp_amount": 8958.03}, {"name": "Moneybox Cash ISA", "category": "Investment Accounts", "amount": 12840.0, "currency": "GBP", "gbp_amount": 12840.0}, {"name": "Amundi Plan Epargne Entreprise Euler Hermes", "category": "Investment Accounts", "amount": 19207.26, "currency": "EUR", "gbp_amount": 16140.55462}, {"name": "Amundi Per Col", "category": "Retirement Accounts", "amount": 5738.89, "currency": "EUR", "gbp_amount": 4822.596639}, {"name": "401K", "category": "Retirement Accounts", "amount": 54961.12, "currency": "USD", "gbp_amount": 41015.76119}, {"name": "Fidelity Investment ISA", "category": "Investment Accounts", "amount": 1814.83, "currency": "GBP", "gbp_amount": 1814.83}, {"name": "Fidelity UK private pension", "category": "Retirement Accounts", "amount": 42457.33, "currency": "GBP", "gbp_amount": 42457.33}, {"name": "Bitcoin", "category": "Crypto", "amount": 256.09, "currency": "GBP", "gbp_amount": 256.09}, {"name": "The Laundry", "category": "Property", "amount": 849600.0, "currency": "GBP", "gbp_amount": 849600.0}, {"name": "Halifax mortgage", "category": "Liabilities", "amount": 338717.16, "currency": "GBP", "gbp_amount": 338717.16}], "total_networth": 653374.7463, "savings_rate": null}, {"date": "2025-06-01", "accounts": [{"name": "Chase Dad's Credit Card", "category": "Cash & Savings", "amount": 21855.52, "currency": "GBP", "gbp_amount": 21855.52}, {"name": "Revolut Pound", "category": "Cash & Savings", "amount": 325.4, "currency": "GBP", "gbp_amount": 325.4}, {"name": "Revolut USD", "category": "Cash & Savings", "amount": 0.67, "currency": "USD", "gbp_amount": 0.4926470588}, {"name": "TreasuryDirect", "category": "Cash & Savings", "amount": 5680.0, "currency": "USD", "gbp_amount": 4176.470588}, {"name": "Tandem saving", "category": "Cash & Savings", "amount": 5742.09, "currency": "GBP", "gbp_amount": 5742.09}, {"name": "Ally savings", "category": "Cash & Savings", "amount": 105.99, "currency": "USD", "gbp_amount": 77.93382353}, {"name": "Revolut rainyday", "category": "Cash & Savings", "amount": 68.9, "currency": "GBP", "gbp_amount": 68.9}, {"name": "Moneybox Lifetime ISA", "category": "Investment Accounts", "amount": 8966.26, "currency": "GBP", "gbp_amount": 8966.26}, {"name": "Moneybox Cash ISA", "category": "Investment Accounts", "amount": 29549.74, "currency": "GBP", "gbp_amount": 29549.74}, {"name": "Amundi Plan Epargne Entreprise Euler Hermes", "category": "Investment Accounts", "amount": 19342.71, "currency": "EUR", "gbp_amount": 16392.12712}, {"name": "Amundi Per Col", "category": "Retirement Accounts", "amount": 5915.5, "currency": "EUR", "gbp_amount": 5013.135593}, {"name": "401K", "category": "Retirement Accounts", "amount": 56326.37, "currency": "USD", "gbp_amount": 41416.44853}, {"name": "Fidelity Investment ISA", "category": "Investment Accounts", "amount": 2135.92, "currency": "GBP", "gbp_amount": 2135.92}, {"name": "Fidelity UK private pension", "category": "Retirement Accounts", "amount": 43761.88, "currency": "GBP", "gbp_amount": 43761.88}, {"name": "Bitcoin", "category": "Crypto", "amount": 313.95, "currency": "GBP", "gbp_amount": 313.95}, {"name": "The Laundry", "category": "Property", "amount": 849600.0, "currency": "GBP", "gbp_amount": 849600.0}, {"name": "Halifax mortgage", "category": "Liabilities", "amount": 338232.04, "currency": "GBP", "gbp_amount": 338232.04}], "total_networth": 691164.2283, "savings_rate": null}, {"date": "2025-11-01", "accounts": [{"name": "Chase Dad's Credit Card", "category": "Cash & Savings", "amount": 13854.2, "currency": "GBP", "gbp_amount": 13854.2}, {"name": "Revolut Pound", "category": "Cash & Savings", "amount": 35.65, "currency": "GBP", "gbp_amount": 35.65}, {"name": "Revolut USD", "category": "Cash & Savings", "amount": 0.67, "currency": "USD", "gbp_amount": 0.5114503817}, {"name": "TreasuryDirect", "category": "Cash & Savings", "amount": 5730.0, "currency": "USD", "gbp_amount": 4374.045802}, {"name": "Ally savings", "category": "Cash & Savings", "amount": 107.53, "currency": "USD", "gbp_amount": 82.08396947}, {"name": "Revolut rainyday", "category": "Cash & Savings", "amount": 4326.21, "currency": "GBP", "gbp_amount": 4326.21}, {"name": "Moneybox Lifetime ISA", "category": "Investment Accounts", "amount": 10538.69, "currency": "GBP", "gbp_amount": 10538.69}, {"name": "Moneybox Cash ISA", "category": "Investment Accounts", "amount": 29982.9, "currency": "GBP", "gbp_amount": 29982.9}, {"name": "Amundi Plan Epargne Entreprise Euler Hermes", "category": "Investment Accounts", "amount": 19740.16, "currency": "EUR", "gbp_amount": 17315.92982}, {"name": "Amundi Per Col", "category": "Retirement Accounts", "amount": 6276.14, "currency": "EUR", "gbp_amount": 5505.385965}, {"name": "401K", "category": "Retirement Accounts", "amount": 56326.37, "currency": "EUR", "gbp_amount": 49409.09649}, {"name": "Fidelity Investment ISA", "category": "Investment Accounts", "amount": 3990.75, "currency": "GBP", "gbp_amount": 3990.75}, {"name": "Fidelity UK private pension", "category": "Retirement Accounts", "amount": 56837.37, "currency": "GBP", "gbp_amount": 56837.37}, {"name": "Bitcoin", "category": "Crypto", "amount": 566.86, "currency": "GBP", "gbp_amount": 566.86}, {"name": "The Laundry", "category": "Property", "amount": 849600.0, "currency": "GBP", "gbp_amount": 849600.0}, {"name": "Halifax mortgage", "category": "Liabilities", "amount": 336054.17, "currency": "GBP", "gbp_amount": 336054.17}], "total_networth": 710365.5135, "savings_rate": null}, {"date": "2025-12-01", "accounts": [{"name": "Chase Dad's Credit Card", "category": "Cash & Savings", "amount": 10878.34, "currency": "GBP", "gbp_amount": 10878.34}, {"name": "Revolut Pound", "category": "Cash & Savings", "amount": 73.4, "currency": "GBP", "gbp_amount": 73.4}, {"name": "Revolut USD", "category": "Cash & Savings", "amount": 0.67, "currency": "USD", "gbp_amount": 0.4962962963}, {"name": "TreasuryDirect", "category": "Cash & Savings", "amount": 5740.0, "currency": "USD", "gbp_amount": 4251.851852}, {"name": "Tandem saving", "category": "Cash & Savings", "amount": 4.73, "currency": "GBP", "gbp_amount": 4.73}, {"name": "Ally savings", "category": "Cash & Savings", "amount": 108.12, "currency": "USD", "gbp_amount": 80.08888889}, {"name": "Revolut rainyday", "category": "Cash & Savings", "amount": 2763.36, "currency": "GBP", "gbp_amount": 2763.36}, {"name": "Moneybox Lifetime ISA", "category": "Investment Accounts", "amount": 10354.34, "currency": "GBP", "gbp_amount": 10354.34}, {"name": "Moneybox Cash ISA", "category": "Investment Accounts", "amount": 30135.49, "currency": "GBP", "gbp_amount": 30135.49}, {"name": "Amundi Plan Epargne Entreprise Euler Hermes", "category": "Investment Accounts", "amount": 19950.81, "currency": "EUR", "gbp_amount": 17348.53043}, {"name": "Amundi Per Col", "category": "Retirement Accounts", "amount": 6250.36, "currency": "EUR", "gbp_amount": 5435.095652}, {"name": "401K", "category": "Retirement Accounts", "amount": 63374.24, "currency": "USD", "gbp_amount": 46943.88148}, {"name": "Fidelity Investment ISA", "category": "Investment Accounts", "amount": 4390.78, "currency": "GBP", "gbp_amount": 4390.78}, {"name": "Fidelity UK private pension", "category": "Retirement Accounts", "amount": 56560.66, "currency": "GBP", "gbp_amount": 56560.66}, {"name": "Bitcoin", "category": "Crypto", "amount": 451.1, "currency": "GBP", "gbp_amount": 451.1}, {"name": "The Laundry", "category": "Property", "amount": 849600.0, "currency": "GBP", "gbp_amount": 849600.0}, {"name": "Halifax mortgage", "category": "Liabilities", "amount": 334182.86, "currency": "GBP", "gbp_amount": 334182.86}], "total_networth": 705089.2846, "savings_rate": null}, {"date": "2026-01-01", "accounts": [{"name": "Chase Dad's Credit Card", "category": "Cash & Savings", "amount": 3409.6, "currency": "GBP", "gbp_amount": 3409.6}, {"name": "Revolut RMB", "category": "Cash & Savings", "amount": 2395.0, "currency": "CNY", "gbp_amount": 251.5756303}, {"name": "Revolut Pound", "category": "Cash & Savings", "amount": 72.74, "currency": "GBP", "gbp_amount": 72.74}, {"name": "Revolut USD", "category": "Cash & Savings", "amount": 0.67, "currency": "USD", "gbp_amount": 0.4890510949}, {"name": "TreasuryDirect", "category": "Cash & Savings", "amount": 5748.0, "currency": "USD", "gbp_amount": 4195.620438}, {"name": "Tandem saving", "category": "Cash & Savings", "amount": 4.74, "currency": "GBP", "gbp_amount": 4.74}, {"name": "Ally savings", "category": "Cash & Savings", "amount": 108.42, "currency": "USD", "gbp_amount": 79.13868613}, {"name": "Moneybox Lifetime ISA", "category": "Investment Accounts", "amount": 10241.28, "currency": "GBP", "gbp_amount": 10241.28}, {"name": "Moneybox Cash ISA", "category": "Investment Accounts", "amount": 30243.89, "currency": "GBP", "gbp_amount": 30243.89}, {"name": "Amundi Plan Epargne Entreprise Euler Hermes", "category": "Investment Accounts", "amount": 4682.06, "currency": "EUR", "gbp_amount": 4071.356522}, {"name": "Amundi Per Col", "category": "Retirement Accounts", "amount": 6297.23, "currency": "EUR", "gbp_amount": 5475.852174}, {"name": "401K", "category": "Retirement Accounts", "amount": 63685.12, "currency": "USD", "gbp_amount": 46485.48905}, {"name": "Trading 212 ISA", "category": "Investment Accounts", "amount": 13269.05, "currency": "GBP", "gbp_amount": 13269.05}, {"name": "Fidelity Investment ISA", "category": "Investment Accounts", "amount": 4427.54, "currency": "GBP", "gbp_amount": 4427.54}, {"name": "Fidelity UK private pension", "category": "Retirement Accounts", "amount": 55566.86, "currency": "GBP", "gbp_amount": 55566.86}, {"name": "Royal London Pension", "category": "Retirement Accounts", "amount": 581.54, "currency": "GBP", "gbp_amount": 581.54}, {"name": "Bitcoin", "category": "Crypto", "amount": 408.8, "currency": "GBP", "gbp_amount": 408.8}, {"name": "The Laundry", "category": "Property", "amount": 849600.0, "currency": "GBP", "gbp_amount": 849600.0}, {"name": "Halifax mortgage", "category": "Liabilities", "amount": 327861.44, "currency": "GBP", "gbp_amount": 327861.44}], "total_networth": 700524.1216, "savings_rate": null}]};

        // Exchange rate cache
        const exchangeRateCache = {};

        // Initialize with embedded data
        async function initializeApp() {
            // Data is embedded in the page
            console.log('Loaded ' + financeData.historical_data.length + ' months of historical data');
            console.log('Loaded ' + financeData.accounts.length + ' accounts');
            
            // Initialize the app
            updateDashboard();
            updateAccountsList();
            updateAccountsEntryList();
            updateDataSummary();
            populateDetailsMonthSelector();
            
            // Set today's date for new entries
            const today = new Date();
            document.getElementById('entry-date').valueAsDate = today;
            
            // Add event listener to date field to load existing entry data
            document.getElementById('entry-date').addEventListener('change', loadEntryForDate);
        }

        // Load existing entry data when date is selected
        function loadEntryForDate() {
            const date = document.getElementById('entry-date').value;
            if (!date) return;

            const existingEntry = financeData.historical_data.find(d => d.date === date);
            
            if (existingEntry) {
                // Pre-fill income and savings data
                document.getElementById('pretax-income').value = existingEntry.pretax_income || '';
                document.getElementById('saved-amount').value = existingEntry.saved_amount || '';
                
                // Recalculate savings rate
                calculateSavingsRate();
                
                // Pre-fill account amounts
                existingEntry.accounts.forEach(acc => {
                    const input = document.querySelector(`.account-input[data-account="${acc.name}"]`);
                    const currencySelect = document.querySelector(`.account-currency[data-account="${acc.name}"]`);
                    
                    if (input) {
                        input.value = acc.amount || '';
                    }
                    if (currencySelect) {
                        currencySelect.value = acc.currency || 'GBP';
                    }
                });
            } else {
                // Clear income/savings fields for new entry
                document.getElementById('pretax-income').value = '';
                document.getElementById('saved-amount').value = '';
                calculateSavingsRate();
            }
        }

        // Fetch exchange rate for a specific date
        async function getExchangeRate(fromCurrency, toCurrency, date) {
            if (fromCurrency === toCurrency) return 1.0;
            
            const cacheKey = `${fromCurrency}_${toCurrency}_${date}`;
            if (exchangeRateCache[cacheKey]) {
                return exchangeRateCache[cacheKey];
            }

            try {
                // Using exchangerate-api.com free tier
                const response = await fetch(`https://api.exchangerate-api.com/v4/latest/${fromCurrency}`);
                const data = await response.json();
                const rate = data.rates[toCurrency];
                exchangeRateCache[cacheKey] = rate;
                return rate;
            } catch (error) {
                console.error('Error fetching exchange rate:', error);
                // Fallback to approximate rates
                const fallbackRates = {
                    'USD_GBP': 0.79,
                    'EUR_GBP': 0.86,
                    'GBP_USD': 1.27,
                    'GBP_EUR': 1.17,
                    'USD_EUR': 0.92,
                    'EUR_USD': 1.09,
                    'CNY_GBP': 0.11
                };
                return fallbackRates[`${fromCurrency}_${toCurrency}`] || 1.0;
            }
        }

        // Convert amount to GBP
        async function convertToGBP(amount, currency, date) {
            if (!amount || amount === 0) return 0;
            const rate = await getExchangeRate(currency, 'GBP', date);
            return amount * rate;
        }

        // Switch tabs
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // Format currency
        function formatCurrency(amount, currency = 'GBP') {
            if (amount === null || amount === undefined) return '—';
            const symbols = { GBP: '£', USD: '$', EUR: '€' };
            return `${symbols[currency] || ''}${amount.toLocaleString('en-GB', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
        }

        // Update dashboard
        function updateDashboard() {
            if (financeData.historical_data.length === 0) return;

            const latestData = financeData.historical_data[financeData.historical_data.length - 1];
            const previousData = financeData.historical_data.length > 1 ? 
                financeData.historical_data[financeData.historical_data.length - 2] : null;

            // Calculate total assets
            const totalAssets = latestData.accounts.reduce((sum, acc) => sum + (acc.gbp_amount || 0), 0);
            document.getElementById('total-assets').textContent = formatCurrency(totalAssets);

            // Net worth
            if (latestData.total_networth) {
                document.getElementById('total-networth').textContent = formatCurrency(latestData.total_networth);
                
                if (previousData && previousData.total_networth) {
                    const change = latestData.total_networth - previousData.total_networth;
                    const changePercent = (change / previousData.total_networth * 100).toFixed(1);
                    const changeEl = document.getElementById('networth-change');
                    changeEl.innerHTML = `<span>${change >= 0 ? '↑' : '↓'} ${formatCurrency(Math.abs(change))} (${Math.abs(changePercent)}%)</span>`;
                    changeEl.className = `stat-change ${change >= 0 ? 'positive' : 'negative'}`;
                }
            }

            // Assets change
            if (previousData) {
                const prevAssets = previousData.accounts.reduce((sum, acc) => sum + (acc.gbp_amount || 0), 0);
                const change = totalAssets - prevAssets;
                const changePercent = (change / prevAssets * 100).toFixed(1);
                const changeEl = document.getElementById('assets-change');
                changeEl.innerHTML = `<span>${change >= 0 ? '↑' : '↓'} ${formatCurrency(Math.abs(change))} (${Math.abs(changePercent)}%)</span>`;
                changeEl.className = `stat-change ${change >= 0 ? 'positive' : 'negative'}`;
            }

            // Savings rate
            if (latestData.savings_rate) {
                document.getElementById('savings-rate').textContent = `${(latestData.savings_rate * 100).toFixed(1)}%`;
            }

            const latestDate = new Date(latestData.date).toLocaleDateString('en-GB', { 
                month: 'short', 
                year: 'numeric' 
            });
            
            // Update date displays
            document.getElementById('networth-date').textContent = `(as of ${latestDate})`;
            document.getElementById('assets-date').textContent = `(as of ${latestDate})`;
            if (latestData.savings_rate) {
                document.getElementById('savings-rate-date').textContent = `as of ${latestDate}`;
            }
            document.getElementById('last-updated').textContent = latestDate;

            // Draw charts
            drawNetworthChart();
            drawAllocationChart();
            drawSavingsChart();
            populateHistoricalTable();
            populateAccountSelector();
        }

        // Populate historical data table
        function populateHistoricalTable() {
            const table = document.getElementById('history-table');
            
            if (financeData.historical_data.length === 0) {
                table.innerHTML = '<tr><td style="text-align: center; color: var(--text-secondary);">No historical data available</td></tr>';
                return;
            }

            // Get all unique account names from historical data
            const allAccounts = new Set();
            financeData.historical_data.forEach(month => {
                month.accounts.forEach(acc => allAccounts.add(acc.name));
            });

            // Build table header
            let headerHTML = '<thead><tr><th>Date</th><th>Net Worth</th><th>Total Assets</th>';
            
            // Show top 5 accounts by latest balance
            const latestMonth = financeData.historical_data[financeData.historical_data.length - 1];
            const topAccounts = [...latestMonth.accounts]
                .sort((a, b) => (b.gbp_amount || 0) - (a.gbp_amount || 0))
                .slice(0, 5);
            
            topAccounts.forEach(acc => {
                headerHTML += `<th>${acc.name}</th>`;
            });
            
            headerHTML += '</tr></thead>';

            // Build table body
            let bodyHTML = '<tbody>';
            
            // Show data in reverse chronological order (most recent first)
            [...financeData.historical_data].reverse().forEach(month => {
                const totalAssets = month.accounts.reduce((sum, acc) => sum + (acc.gbp_amount || 0), 0);
                const date = new Date(month.date).toLocaleDateString('en-GB', { month: 'short', year: 'numeric' });
                
                bodyHTML += `<tr>
                    <td style="font-weight: 600;">${date}</td>
                    <td style="color: var(--accent-gold);">${formatCurrency(month.total_networth || totalAssets)}</td>
                    <td>${formatCurrency(totalAssets)}</td>`;
                
                topAccounts.forEach(topAcc => {
                    const acc = month.accounts.find(a => a.name === topAcc.name);
                    if (acc && acc.gbp_amount) {
                        const badge = acc.currency !== 'GBP' ? `<span class="currency-badge">${acc.currency}</span>` : '';
                        bodyHTML += `<td>${formatCurrency(acc.gbp_amount)}${badge}</td>`;
                    } else {
                        bodyHTML += `<td style="color: var(--text-muted);">—</td>`;
                    }
                });
                
                bodyHTML += '</tr>';
            });
            
            bodyHTML += '</tbody>';
            
            table.innerHTML = headerHTML + bodyHTML;
        }

        // Populate account selector for history chart
        function populateAccountSelector() {
            const select = document.getElementById('account-select');
            
            // Get unique accounts that appear in historical data
            const accountsInHistory = new Set();
            financeData.historical_data.forEach(month => {
                month.accounts.forEach(acc => accountsInHistory.add(acc.name));
            });

            // Sort alphabetically
            const sortedAccounts = Array.from(accountsInHistory).sort();

            select.innerHTML = '<option value="">-- Select an account --</option>' + 
                sortedAccounts.map(name => `<option value="${name}">${name}</option>`).join('');
        }

        // Draw account history chart
        function drawAccountHistory() {
            const accountName = document.getElementById('account-select').value;
            if (!accountName) {
                document.getElementById('account-history-container').style.display = 'none';
                return;
            }

            document.getElementById('account-history-container').style.display = 'block';

            const ctx = document.getElementById('account-history-chart');
            if (window.accountHistoryChart) window.accountHistoryChart.destroy();

            const labels = [];
            const data = [];
            const currencies = [];
            const gbpAmounts = [];

            // Determine the primary currency for this account (most common currency used)
            const currencyCounts = {};
            financeData.historical_data.forEach(month => {
                const account = month.accounts.find(acc => acc.name === accountName);
                if (account && account.currency) {
                    currencyCounts[account.currency] = (currencyCounts[account.currency] || 0) + 1;
                }
            });
            const primaryCurrency = Object.keys(currencyCounts).sort((a, b) => currencyCounts[b] - currencyCounts[a])[0] || 'GBP';

            financeData.historical_data.forEach(month => {
                const account = month.accounts.find(acc => acc.name === accountName);
                labels.push(new Date(month.date).toLocaleDateString('en-GB', { month: 'short', year: 'numeric' }));
                
                // Use original amount in original currency
                data.push(account ? (account.amount || 0) : 0);
                currencies.push(account ? account.currency : primaryCurrency);
                gbpAmounts.push(account ? (account.gbp_amount || 0) : 0);
            });

            const currencySymbols = { GBP: '£', USD: '$', EUR: '€', CNY: '¥' };
            const currencySymbol = currencySymbols[primaryCurrency] || primaryCurrency + ' ';

            window.accountHistoryChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `${accountName} (${primaryCurrency})`,
                        data: data,
                        borderColor: '#60a5fa',
                        backgroundColor: 'rgba(96, 165, 250, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        pointBackgroundColor: '#60a5fa',
                        pointBorderColor: '#0a0e12',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            display: true,
                            labels: {
                                color: '#f8fafc',
                                font: { size: 14, family: 'IBM Plex Mono' },
                                padding: 15
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(20, 25, 32, 0.95)',
                            titleColor: '#60a5fa',
                            bodyColor: '#f8fafc',
                            borderColor: '#60a5fa',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: false,
                            callbacks: {
                                label: (context) => {
                                    const currency = currencies[context.dataIndex];
                                    const symbol = currencySymbols[currency] || currency + ' ';
                                    const gbpAmount = gbpAmounts[context.dataIndex];
                                    return [
                                        `${symbol}${context.parsed.y.toLocaleString('en-GB', { maximumFractionDigits: 0 })}`,
                                        `(£${gbpAmount.toLocaleString('en-GB', { maximumFractionDigits: 0 })} GBP)`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: { 
                                color: '#94a3b8',
                                callback: (value) => currencySymbol + value.toLocaleString('en-GB', { maximumFractionDigits: 0 })
                            },
                            grid: { color: 'rgba(45, 55, 72, 0.5)' }
                        },
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        // Draw net worth chart
        function drawNetworthChart() {
            const ctx = document.getElementById('networth-chart');
            if (window.networthChart) window.networthChart.destroy();

            const labels = financeData.historical_data.map(d => 
                new Date(d.date).toLocaleDateString('en-GB', { month: 'short', year: 'numeric' })
            );
            const data = financeData.historical_data.map(d => d.total_networth || 0);

            window.networthChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Net Worth',
                        data: data,
                        borderColor: '#d4af37',
                        backgroundColor: 'rgba(212, 175, 55, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        pointBackgroundColor: '#d4af37',
                        pointBorderColor: '#0a0e12',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(20, 25, 32, 0.95)',
                            titleColor: '#d4af37',
                            bodyColor: '#f8fafc',
                            borderColor: '#d4af37',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: false,
                            callbacks: {
                                label: (context) => `£${Math.round(context.parsed.y).toLocaleString('en-GB')}`
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: { 
                                color: '#94a3b8',
                                callback: (value) => '£' + (value / 1000).toFixed(0) + 'k'
                            },
                            grid: { color: 'rgba(45, 55, 72, 0.5)' }
                        },
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        // Draw allocation chart
        function drawAllocationChart() {
            const ctx = document.getElementById('allocation-chart');
            if (window.allocationChart) window.allocationChart.destroy();

            if (financeData.historical_data.length === 0) return;

            const latestData = financeData.historical_data[financeData.historical_data.length - 1];
            const categoryTotals = {};

            latestData.accounts.forEach(acc => {
                if (!categoryTotals[acc.category]) {
                    categoryTotals[acc.category] = 0;
                }
                categoryTotals[acc.category] += acc.gbp_amount || 0;
            });

            const labels = Object.keys(categoryTotals);
            const data = Object.values(categoryTotals);
            const colors = ['#d4af37', '#4ade80', '#60a5fa', '#f472b6', '#a78bfa'];

            window.allocationChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderColor: '#0a0e12',
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: '#f8fafc',
                                font: { size: 14, family: 'IBM Plex Mono' },
                                padding: 15,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(20, 25, 32, 0.95)',
                            titleColor: '#d4af37',
                            bodyColor: '#f8fafc',
                            borderColor: '#d4af37',
                            borderWidth: 1,
                            padding: 12,
                            callbacks: {
                                label: (context) => {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percent = ((context.parsed / total) * 100).toFixed(1);
                                    return `${context.label}: £${context.parsed.toLocaleString('en-GB')} (${percent}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Draw savings rate chart
        function drawSavingsChart() {
            const ctx = document.getElementById('savings-chart');
            if (window.savingsChart) window.savingsChart.destroy();

            const labels = financeData.historical_data.map(d => 
                new Date(d.date).toLocaleDateString('en-GB', { month: 'short', year: 'numeric' })
            );
            const data = financeData.historical_data.map(d => 
                d.savings_rate ? (d.savings_rate * 100) : null
            );

            window.savingsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Savings Rate',
                        data: data,
                        backgroundColor: 'rgba(74, 222, 128, 0.7)',
                        borderColor: '#4ade80',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(20, 25, 32, 0.95)',
                            titleColor: '#4ade80',
                            bodyColor: '#f8fafc',
                            borderColor: '#4ade80',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: false,
                            callbacks: {
                                label: (context) => `${context.parsed.y.toFixed(1)}%`
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: { 
                                color: '#94a3b8',
                                callback: (value) => value + '%'
                            },
                            grid: { color: 'rgba(45, 55, 72, 0.5)' }
                        },
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        // Update accounts list
        function updateAccountsList() {
            const container = document.getElementById('accounts-list');
            const accounts = financeData.accounts;

            if (accounts.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">No accounts yet. Add your first account above.</p>';
                return;
            }

            const grouped = accounts.reduce((acc, account) => {
                if (!acc[account.category]) acc[account.category] = [];
                acc[account.category].push(account);
                return acc;
            }, {});

            container.innerHTML = Object.entries(grouped).map(([category, accs]) => `
                <div style="margin-bottom: 25px;">
                    <h3 style="font-family: 'IBM Plex Mono', monospace; color: var(--accent-gold); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 15px;">
                        ${category}
                    </h3>
                    <div style="display: grid; gap: 10px;">
                        ${accs.map(acc => `
                            <div style="background: var(--bg-tertiary); padding: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                                <span style="color: var(--text-primary);">${acc.name}</span>
                                <button onclick="removeAccount('${acc.name}')" style="padding: 6px 12px; font-size: 0.75rem; background: var(--accent-red);">Remove</button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        // Update accounts entry list
        function updateAccountsEntryList() {
            const container = document.getElementById('accounts-entry-list');
            const accounts = financeData.accounts;

            // Get the last month's data to pre-fill currencies and The Laundry amount
            const lastMonth = financeData.historical_data.length > 0 ? 
                financeData.historical_data[financeData.historical_data.length - 1] : null;

            // Group accounts by category (exclude archived accounts)
            const grouped = {};
            accounts.forEach(acc => {
                // Skip archived accounts
                if (acc.archived) return;
                
                if (!grouped[acc.category]) {
                    grouped[acc.category] = [];
                }
                grouped[acc.category].push(acc);
            });

            // Define category order
            const categoryOrder = ['Cash & Savings', 'Investment Accounts', 'Retirement Accounts', 'Property', 'Crypto', 'Liabilities'];

            // Build HTML with table layout
            let html = '<table class="entry-table">';
            html += '<thead><tr><th>Account Name</th><th>Amount</th><th>Currency</th><th style="width: 80px;">Action</th></tr></thead>';
            html += '<tbody>';

            categoryOrder.forEach(category => {
                if (!grouped[category]) {
                    grouped[category] = [];
                }

                // Add category header row with quick add button
                html += `
                    <tr>
                        <td colspan="4" class="entry-category-header">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span>${category}</span>
                                <button type="button" onclick="event.preventDefault(); event.stopPropagation(); quickAddAccount('${category}');" style="padding: 4px 12px; font-size: 0.7rem; background: var(--bg-secondary); color: var(--accent-gold); border: 1px solid var(--accent-gold);">
                                    + Add Account
                                </button>
                            </div>
                        </td>
                    </tr>
                `;

                // Add accounts in this category
                grouped[category].forEach(acc => {
                    // Find this account's last currency and amount
                    let lastCurrency = 'GBP';
                    let lastAmount = '';
                    
                    if (lastMonth) {
                        const lastAccountData = lastMonth.accounts.find(a => a.name === acc.name);
                        if (lastAccountData) {
                            lastCurrency = lastAccountData.currency || 'GBP';
                            // Pre-fill The Laundry with last month's value
                            if (acc.name === 'The Laundry') {
                                lastAmount = lastAccountData.amount || '';
                            }
                        }
                    }

                    html += `
                        <tr>
                            <td style="font-weight: 500;">${acc.name}</td>
                            <td>
                                <input type="number" class="account-input" data-account="${acc.name}" placeholder="0.00" step="0.01" value="${lastAmount}">
                            </td>
                            <td>
                                <select class="account-currency" data-account="${acc.name}">
                                    <option value="GBP" ${lastCurrency === 'GBP' ? 'selected' : ''}>GBP</option>
                                    <option value="USD" ${lastCurrency === 'USD' ? 'selected' : ''}>USD</option>
                                    <option value="EUR" ${lastCurrency === 'EUR' ? 'selected' : ''}>EUR</option>
                                    <option value="CNY" ${lastCurrency === 'CNY' ? 'selected' : ''}>CNY</option>
                                </select>
                            </td>
                            <td style="text-align: center;">
                                <button type="button" onclick="event.preventDefault(); event.stopPropagation(); archiveAccount('${acc.name}');" title="Archive this account" style="padding: 4px 8px; font-size: 0.7rem; background: transparent; color: var(--text-muted); border: 1px solid var(--border-color);">
                                    Archive
                                </button>
                            </td>
                        </tr>
                    `;
                });
            });

            html += '</tbody></table>';
            
            // Show archived accounts section if any exist
            const archivedAccounts = accounts.filter(acc => acc.archived);
            if (archivedAccounts.length > 0) {
                html += `
                    <div style="margin-top: 30px; padding: 20px; background: var(--bg-tertiary); border-radius: 8px;">
                        <h3 style="font-family: 'IBM Plex Mono', monospace; color: var(--text-muted); font-size: 0.9rem; margin-bottom: 15px; cursor: pointer;" onclick="toggleArchivedAccounts()">
                            📦 Archived Accounts (${archivedAccounts.length}) - Click to ${window.showArchivedAccounts ? 'hide' : 'show'}
                        </h3>
                        <div id="archived-accounts-list" style="display: ${window.showArchivedAccounts ? 'block' : 'none'};">
                            ${archivedAccounts.map(acc => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; margin-bottom: 5px; background: var(--bg-secondary); border-radius: 6px;">
                                    <span style="color: var(--text-secondary);">${acc.name} <span style="font-size: 0.8rem; opacity: 0.7;">(${acc.category})</span></span>
                                    <button type="button" onclick="event.preventDefault(); event.stopPropagation(); unarchiveAccount('${acc.name}');" style="padding: 4px 12px; font-size: 0.7rem; background: var(--accent-gold); color: var(--bg-primary);">
                                        Unarchive
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        // Toggle archived accounts visibility
        function toggleArchivedAccounts() {
            window.showArchivedAccounts = !window.showArchivedAccounts;
            updateAccountsEntryList();
        }

        // Archive an account
        function archiveAccount(accountName) {
            if (!confirm(`Archive "${accountName}"?\n\nThis will hide it from the Add Entry form, but all historical data will be preserved.`)) {
                return;
            }

            const account = financeData.accounts.find(acc => acc.name === accountName);
            if (account) {
                account.archived = true;
                updateAccountsEntryList();
                updateAccountsList();
                
                const entryMsg = document.getElementById('entry-message');
                entryMsg.innerHTML = `<div class="success-message">"${accountName}" has been archived. Historical data is preserved.</div>`;
                setTimeout(() => entryMsg.innerHTML = '', 3000);
            }
        }

        // Unarchive an account
        function unarchiveAccount(accountName) {
            const account = financeData.accounts.find(acc => acc.name === accountName);
            if (account) {
                account.archived = false;
                updateAccountsEntryList();
                updateAccountsList();
                
                const entryMsg = document.getElementById('entry-message');
                entryMsg.innerHTML = `<div class="success-message">"${accountName}" has been unarchived and is now visible.</div>`;
                setTimeout(() => entryMsg.innerHTML = '', 3000);
            }
        }

        // Quick add account from entry form
        function quickAddAccount(category) {
            const name = prompt(`Add new account to "${category}":\n\nEnter account name:`);
            
            if (!name || !name.trim()) {
                return;
            }

            const accountName = name.trim();

            // Check if account already exists
            if (financeData.accounts.some(acc => acc.name === accountName)) {
                alert('An account with this name already exists.');
                return;
            }

            // Add to accounts list
            financeData.accounts.push({
                name: accountName,
                category: category
            });

            // Refresh the entry list and accounts list
            updateAccountsEntryList();
            updateAccountsList();

            // Show success message
            const entryMsg = document.getElementById('entry-message');
            entryMsg.innerHTML = `<div class="success-message">Added "${accountName}" to ${category}. You can now enter a value for this account.</div>`;
            setTimeout(() => entryMsg.innerHTML = '', 3000);

            // Scroll to the new account's category
            const table = document.querySelector('#accounts-entry-list table');
            if (table) {
                const categoryHeaders = table.querySelectorAll('.entry-category-header');
                categoryHeaders.forEach(header => {
                    if (header.textContent.includes(category)) {
                        header.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                });
            }
        }

        // Add account
        function addAccount() {
            const name = document.getElementById('account-name').value.trim();
            const category = document.getElementById('account-category').value;
            const currency = document.getElementById('account-currency').value;

            if (!name) {
                showMessage('account-message', 'Please enter an account name', 'error');
                return;
            }

            if (financeData.accounts.some(acc => acc.name === name)) {
                showMessage('account-message', 'Account already exists', 'error');
                return;
            }

            financeData.accounts.push({ name, category, row_index: financeData.accounts.length + 9 });
            
            document.getElementById('account-name').value = '';
            showMessage('account-message', 'Account added successfully', 'success');
            updateAccountsList();
            updateAccountsEntryList();
        }

        // Remove account
        function removeAccount(name) {
            if (!confirm(`Are you sure you want to remove "${name}"?`)) return;

            financeData.accounts = financeData.accounts.filter(acc => acc.name !== name);
            
            // Remove from historical data
            financeData.historical_data.forEach(month => {
                month.accounts = month.accounts.filter(acc => acc.name !== name);
            });

            showMessage('account-message', 'Account removed', 'success');
            updateAccountsList();
            updateAccountsEntryList();
            updateDashboard();
        }

        // Calculate savings rate
        function calculateSavingsRate() {
            const pretaxIncome = parseFloat(document.getElementById('pretax-income').value) || 0;
            const savedAmount = parseFloat(document.getElementById('saved-amount').value) || 0;
            
            const display = document.getElementById('calculated-savings-rate');
            
            if (pretaxIncome > 0 && savedAmount > 0) {
                const savingsRate = (savedAmount / pretaxIncome) * 100;
                display.textContent = savingsRate.toFixed(1) + '%';
                display.style.color = savingsRate >= 50 ? 'var(--accent-green)' : 
                                      savingsRate >= 30 ? 'var(--accent-gold)' : 
                                      'var(--text-primary)';
            } else {
                display.textContent = '—';
                display.style.color = 'var(--text-primary)';
            }

            // Calculate net worth change if possible
            calculateNetworthChange();
        }

        // Calculate net worth change based on entered accounts
        function calculateNetworthChange() {
            const date = document.getElementById('entry-date').value;
            if (!date) return;

            // Find previous month's data
            const currentMonthIndex = financeData.historical_data.findIndex(d => d.date === date);
            const previousMonth = currentMonthIndex > 0 ? financeData.historical_data[currentMonthIndex - 1] : 
                                  financeData.historical_data.length > 0 ? financeData.historical_data[financeData.historical_data.length - 1] : null;

            if (!previousMonth) {
                document.getElementById('networth-change-display').textContent = '—';
                return;
            }

            // Calculate current total from inputs
            let currentTotal = 0;
            const inputs = document.querySelectorAll('.account-input');
            
            for (const input of inputs) {
                const amount = parseFloat(input.value);
                if (amount && amount > 0) {
                    const accountName = input.dataset.account;
                    const currency = document.querySelector(`.account-currency[data-account="${accountName}"]`).value;
                    
                    // Simple conversion (will be more accurate when saved with real rates)
                    const conversionRates = { GBP: 1, USD: 0.79, EUR: 0.86, CNY: 0.11 };
                    const gbpAmount = amount * (conversionRates[currency] || 1);
                    currentTotal += gbpAmount;
                }
            }

            const previousTotal = previousMonth.total_networth || 
                                  previousMonth.accounts.reduce((sum, acc) => sum + (acc.gbp_amount || 0), 0);

            const change = currentTotal - previousTotal;
            const display = document.getElementById('networth-change-display');
            
            if (change !== 0) {
                const changeText = (change >= 0 ? '+' : '') + formatCurrency(change);
                display.textContent = changeText;
                display.style.color = change >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
            } else {
                display.textContent = '—';
                display.style.color = 'var(--text-primary)';
            }
        }

        // Save entry
        async function saveEntry() {
            const date = document.getElementById('entry-date').value;
            if (!date) {
                showMessage('entry-message', 'Please select a date', 'error');
                return;
            }

            const messageEl = document.getElementById('entry-message');
            messageEl.innerHTML = '<div class="loading"><div class="spinner"></div>Fetching exchange rates...</div>';

            const accounts = [];
            const inputs = document.querySelectorAll('.account-input');

            for (const input of inputs) {
                const amount = parseFloat(input.value);
                if (amount && amount > 0) {
                    const accountName = input.dataset.account;
                    const currency = document.querySelector(`.account-currency[data-account="${accountName}"]`).value;
                    const account = financeData.accounts.find(acc => acc.name === accountName);

                    const gbpAmount = await convertToGBP(amount, currency, date);

                    accounts.push({
                        name: accountName,
                        category: account.category,
                        amount: amount,
                        currency: currency,
                        gbp_amount: gbpAmount
                    });
                }
            }

            if (accounts.length === 0) {
                showMessage('entry-message', 'Please enter at least one account balance', 'error');
                return;
            }

            // Calculate totals
            const totalAssets = accounts.reduce((sum, acc) => sum + acc.gbp_amount, 0);

            // Get income and savings data
            const pretaxIncome = parseFloat(document.getElementById('pretax-income').value) || null;
            const savedAmount = parseFloat(document.getElementById('saved-amount').value) || null;
            const savingsRate = (pretaxIncome && savedAmount) ? (savedAmount / pretaxIncome) : null;

            // Check if entry for this date exists
            const existingIndex = financeData.historical_data.findIndex(d => d.date === date);
            const entryData = {
                date: date,
                accounts: accounts,
                total_networth: totalAssets,
                savings_rate: savingsRate,
                pretax_income: pretaxIncome,
                saved_amount: savedAmount
            };

            if (existingIndex >= 0) {
                financeData.historical_data[existingIndex] = entryData;
            } else {
                financeData.historical_data.push(entryData);
            }

            // Sort by date
            financeData.historical_data.sort((a, b) => new Date(a.date) - new Date(b.date));

            showMessage('entry-message', 'Entry saved successfully!', 'success');
            updateDashboard();
            updateDataSummary();

            // Clear inputs
            inputs.forEach(input => input.value = '');
        }

        // Import data
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const imported = JSON.parse(e.target.result);
                    financeData = imported;
                    
                    showMessage('import-message', 'Data imported successfully!', 'success');
                    updateDashboard();
                    updateAccountsList();
                    updateAccountsEntryList();
                    updateDataSummary();
                } catch (error) {
                    showMessage('import-message', 'Error importing data: Invalid file format', 'error');
                }
            };
            reader.readAsText(file);
        }

        // Export data
        function exportData() {
            const dataStr = JSON.stringify(financeData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `finance-data-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Update data summary
        function updateDataSummary() {
            const container = document.getElementById('data-summary');
            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                    <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 8px; text-align: center;">
                        <div style="font-family: 'IBM Plex Mono', monospace; font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 10px;">Total Accounts</div>
                        <div style="font-size: 2rem; color: var(--accent-gold); font-weight: 600;">${financeData.accounts.length}</div>
                    </div>
                    <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 8px; text-align: center;">
                        <div style="font-family: 'IBM Plex Mono', monospace; font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 10px;">Historical Entries</div>
                        <div style="font-size: 2rem; color: var(--accent-gold); font-weight: 600;">${financeData.historical_data.length}</div>
                    </div>
                    <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 8px; text-align: center;">
                        <div style="font-family: 'IBM Plex Mono', monospace; font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 10px;">Date Range</div>
                        <div style="font-size: 1.2rem; color: var(--accent-gold); font-weight: 600;">
                            ${financeData.historical_data.length > 0 ? 
                                new Date(financeData.historical_data[0].date).toLocaleDateString('en-GB', { month: 'short', year: 'numeric' }) + ' - ' +
                                new Date(financeData.historical_data[financeData.historical_data.length - 1].date).toLocaleDateString('en-GB', { month: 'short', year: 'numeric' })
                                : '—'
                            }
                        </div>
                    </div>
                </div>
            `;
        }

        // Show message
        function showMessage(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="${type}-message">${message}</div>`;
            setTimeout(() => element.innerHTML = '', 5000);
        }

        // Initialize app on load
        window.addEventListener('load', initializeApp);

        // Details tab functions
        function populateDetailsMonthSelector() {
            const select = document.getElementById('details-month-select');
            
            // Populate with all available months in reverse order (most recent first)
            const options = [...financeData.historical_data].reverse().map((month, idx) => {
                const date = new Date(month.date);
                const label = date.toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });
                const value = financeData.historical_data.length - 1 - idx;
                return `<option value="${value}">${label}</option>`;
            }).join('');
            
            select.innerHTML = options;
            
            // Load the latest month by default
            updateDetailsTable();
        }

        let detailsSortColumn = null;
        let detailsSortAscending = true;

        function updateDetailsTable() {
            const monthIndex = parseInt(document.getElementById('details-month-select').value);
            const monthData = financeData.historical_data[monthIndex];
            
            if (!monthData) return;

            const table = document.getElementById('details-table');
            
            // Group accounts by category
            const grouped = {};
            monthData.accounts.forEach(acc => {
                if (!grouped[acc.category]) {
                    grouped[acc.category] = [];
                }
                grouped[acc.category].push(acc);
            });

            // Build table
            let html = `
                <thead>
                    <tr>
                        <th onclick="sortDetailsTable('name')">Account Name</th>
                        <th onclick="sortDetailsTable('category')">Category</th>
                        <th onclick="sortDetailsTable('amount')" style="text-align: right;">Original Amount</th>
                        <th onclick="sortDetailsTable('currency')" style="text-align: center;">Currency</th>
                        <th onclick="sortDetailsTable('gbp')" style="text-align: right;">GBP Equivalent</th>
                    </tr>
                </thead>
                <tbody>
            `;

            // Sort all accounts
            let allAccounts = monthData.accounts.slice();
            if (detailsSortColumn) {
                allAccounts.sort((a, b) => {
                    let aVal, bVal;
                    switch(detailsSortColumn) {
                        case 'name': 
                            aVal = a.name; bVal = b.name; 
                            break;
                        case 'category': 
                            aVal = a.category; bVal = b.category; 
                            break;
                        case 'amount': 
                            aVal = a.amount || 0; bVal = b.amount || 0; 
                            break;
                        case 'currency': 
                            aVal = a.currency; bVal = b.currency; 
                            break;
                        case 'gbp': 
                            aVal = a.gbp_amount || 0; bVal = b.gbp_amount || 0; 
                            break;
                    }
                    if (typeof aVal === 'string') {
                        return detailsSortAscending ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                    } else {
                        return detailsSortAscending ? aVal - bVal : bVal - aVal;
                    }
                });
            }

            // Display accounts
            allAccounts.forEach(acc => {
                const currencySymbols = { GBP: '£', USD: '$', EUR: '€', CNY: '¥' };
                const symbol = currencySymbols[acc.currency] || '';
                const amount = acc.amount ? `${symbol}${acc.amount.toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}` : '—';
                const gbpAmount = acc.gbp_amount ? `£${acc.gbp_amount.toLocaleString('en-GB', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}` : '—';

                html += `
                    <tr>
                        <td>${acc.name}</td>
                        <td class="category-cell">${acc.category}</td>
                        <td class="amount-cell">${amount}</td>
                        <td class="currency-cell">${acc.currency}</td>
                        <td class="gbp-cell">${gbpAmount}</td>
                    </tr>
                `;
            });

            html += '</tbody>';
            table.innerHTML = html;

            // Update summary
            updateDetailsSummary(monthData);
        }

        function sortDetailsTable(column) {
            if (detailsSortColumn === column) {
                detailsSortAscending = !detailsSortAscending;
            } else {
                detailsSortColumn = column;
                detailsSortAscending = true;
            }
            updateDetailsTable();
        }

        function updateDetailsSummary(monthData) {
            const summary = document.getElementById('details-summary');
            
            // Calculate totals by category
            const categoryTotals = {};
            monthData.accounts.forEach(acc => {
                if (!categoryTotals[acc.category]) {
                    categoryTotals[acc.category] = 0;
                }
                categoryTotals[acc.category] += acc.gbp_amount || 0;
            });

            // Calculate grand total
            const grandTotal = Object.values(categoryTotals).reduce((sum, val) => sum + val, 0);

            // Build summary HTML
            let html = '';
            
            // Show each category
            Object.entries(categoryTotals).sort((a, b) => b[1] - a[1]).forEach(([category, total]) => {
                const percentage = ((total / grandTotal) * 100).toFixed(1);
                html += `
                    <div style="padding: 10px; background: var(--bg-secondary); border-radius: 6px;">
                        <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 5px;">${category}</div>
                        <div style="font-size: 1.2rem; font-weight: 600; color: var(--text-primary);">${formatCurrency(total)}</div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">${percentage}%</div>
                    </div>
                `;
            });

            // Add grand total
            html += `
                <div style="padding: 10px; background: rgba(212, 175, 55, 0.1); border: 1px solid var(--accent-gold); border-radius: 6px;">
                    <div style="font-size: 0.7rem; color: var(--accent-gold); text-transform: uppercase; margin-bottom: 5px;">Total</div>
                    <div style="font-size: 1.4rem; font-weight: 700; color: var(--accent-gold);">${formatCurrency(grandTotal)}</div>
                    <div style="font-size: 0.75rem; color: var(--text-secondary);">${monthData.accounts.length} accounts</div>
                </div>
            `;

            summary.innerHTML = html;
        }

        function exportDetailsToCSV() {
            const monthIndex = parseInt(document.getElementById('details-month-select').value);
            const monthData = financeData.historical_data[monthIndex];
            const date = new Date(monthData.date).toLocaleDateString('en-GB', { month: 'short', year: 'numeric' });
            
            // Build CSV content
            let csv = 'Account Name,Category,Original Amount,Currency,GBP Equivalent\n';
            
            monthData.accounts.forEach(acc => {
                const amount = acc.amount || 0;
                const gbpAmount = acc.gbp_amount || 0;
                csv += `"${acc.name}","${acc.category}",${amount},"${acc.currency}",${gbpAmount}\n`;
            });

            // Add summary section
            csv += '\n\nCategory Summary\n';
            const categoryTotals = {};
            monthData.accounts.forEach(acc => {
                if (!categoryTotals[acc.category]) {
                    categoryTotals[acc.category] = 0;
                }
                categoryTotals[acc.category] += acc.gbp_amount || 0;
            });

            Object.entries(categoryTotals).forEach(([category, total]) => {
                csv += `"${category}",,,,"${total}"\n`;
            });

            const total = Object.values(categoryTotals).reduce((sum, val) => sum + val, 0);
            csv += `"TOTAL",,,,"${total}"\n`;

            // Download CSV
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `finance-details-${date.replace(' ', '-')}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // AI Chat Functions
        function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message) return;

            // Add user message to chat
            addChatMessage('user', message);
            input.value = '';

            // Show loading
            const chatMessages = document.getElementById('chat-messages');
            const loadingId = 'loading-' + Date.now();
            chatMessages.innerHTML += `<div class="chat-loading" id="${loadingId}">Analyzing your data...</div>`;
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // Analyze and respond
            setTimeout(() => {
                const response = analyzeFinancialData(message);
                document.getElementById(loadingId).remove();
                addChatMessage('ai', response);
            }, 500);
        }

        function addChatMessage(sender, content) {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}`;
            messageDiv.innerHTML = `
                <div class="sender">${sender === 'user' ? 'You' : 'AI Assistant'}</div>
                <div class="content">${content}</div>
            `;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function analyzeFinancialData(question) {
            const lowerQ = question.toLowerCase();
            
            if (financeData.historical_data.length < 2) {
                return "I need at least 2 months of data to perform meaningful analysis. Please add more entries first.";
            }

            const latestMonth = financeData.historical_data[financeData.historical_data.length - 1];
            const previousMonth = financeData.historical_data[financeData.historical_data.length - 2];

            // Net worth change analysis
            if (lowerQ.includes('net worth') || lowerQ.includes('total') || lowerQ.includes('change') || lowerQ.includes('down') || lowerQ.includes('up')) {
                const latestTotal = latestMonth.total_networth || latestMonth.accounts.reduce((sum, acc) => sum + (acc.gbp_amount || 0), 0);
                const previousTotal = previousMonth.total_networth || previousMonth.accounts.reduce((sum, acc) => sum + (acc.gbp_amount || 0), 0);
                const change = latestTotal - previousTotal;
                const changePercent = ((change / previousTotal) * 100).toFixed(1);

                let response = `<strong>Net Worth Analysis:</strong><br><br>`;
                response += `Latest (${new Date(latestMonth.date).toLocaleDateString('en-GB', {month: 'short', year: 'numeric'})}): ${formatCurrency(latestTotal)}<br>`;
                response += `Previous (${new Date(previousMonth.date).toLocaleDateString('en-GB', {month: 'short', year: 'numeric'})}): ${formatCurrency(previousTotal)}<br>`;
                response += `Change: ${formatCurrency(Math.abs(change))} (${changePercent}%) ${change >= 0 ? '📈' : '📉'}<br><br>`;

                // Find major contributors
                const accountChanges = [];
                latestMonth.accounts.forEach(acc => {
                    const prevAcc = previousMonth.accounts.find(a => a.name === acc.name);
                    if (prevAcc) {
                        const accChange = (acc.gbp_amount || 0) - (prevAcc.gbp_amount || 0);
                        if (Math.abs(accChange) > 100) {
                            accountChanges.push({ name: acc.name, change: accChange, category: acc.category });
                        }
                    }
                });

                accountChanges.sort((a, b) => Math.abs(b.change) - Math.abs(a.change));

                if (accountChanges.length > 0) {
                    response += `<strong>Major Contributors:</strong><br>`;
                    accountChanges.slice(0, 5).forEach(acc => {
                        const sign = acc.change >= 0 ? '+' : '';
                        response += `• ${acc.name}: ${sign}${formatCurrency(acc.change)} (${acc.category})<br>`;
                    });
                } else {
                    response += `No significant individual account changes detected.`;
                }

                return response;
            }

            // Growth analysis
            if (lowerQ.includes('grow') || lowerQ.includes('increase') || lowerQ.includes('most')) {
                const accountChanges = [];
                latestMonth.accounts.forEach(acc => {
                    const prevAcc = previousMonth.accounts.find(a => a.name === acc.name);
                    if (prevAcc && prevAcc.gbp_amount) {
                        const accChange = (acc.gbp_amount || 0) - (prevAcc.gbp_amount || 0);
                        const percentChange = ((accChange / prevAcc.gbp_amount) * 100).toFixed(1);
                        accountChanges.push({ 
                            name: acc.name, 
                            change: accChange, 
                            percent: percentChange,
                            category: acc.category 
                        });
                    }
                });

                accountChanges.sort((a, b) => b.change - a.change);

                let response = `<strong>Top Growing Accounts:</strong><br><br>`;
                accountChanges.slice(0, 5).forEach((acc, idx) => {
                    response += `${idx + 1}. ${acc.name}: +${formatCurrency(acc.change)} (+${acc.percent}%)<br>`;
                });

                return response;
            }

            // Savings rate analysis
            if (lowerQ.includes('saving') || lowerQ.includes('save')) {
                const rates = financeData.historical_data
                    .filter(m => m.savings_rate)
                    .map(m => ({ date: m.date, rate: m.savings_rate * 100 }));

                if (rates.length === 0) {
                    return "No savings rate data available. Please enter pre-tax income and saved amounts in your monthly entries.";
                }

                const avgRate = (rates.reduce((sum, r) => sum + r.rate, 0) / rates.length).toFixed(1);
                const latestRate = rates[rates.length - 1].rate.toFixed(1);

                let response = `<strong>Savings Rate Analysis:</strong><br><br>`;
                response += `Current: ${latestRate}%<br>`;
                response += `Average: ${avgRate}%<br><br>`;
                response += `<strong>History:</strong><br>`;
                rates.slice(-6).forEach(r => {
                    const date = new Date(r.date).toLocaleDateString('en-GB', {month: 'short', year: 'numeric'});
                    response += `• ${date}: ${r.rate.toFixed(1)}%<br>`;
                });

                return response;
            }

            // Asset allocation
            if (lowerQ.includes('allocation') || lowerQ.includes('category') || lowerQ.includes('breakdown')) {
                const categories = {};
                latestMonth.accounts.forEach(acc => {
                    if (!categories[acc.category]) categories[acc.category] = 0;
                    categories[acc.category] += acc.gbp_amount || 0;
                });

                const total = Object.values(categories).reduce((sum, val) => sum + val, 0);

                let response = `<strong>Current Asset Allocation:</strong><br><br>`;
                Object.entries(categories)
                    .sort((a, b) => b[1] - a[1])
                    .forEach(([cat, amount]) => {
                        const percent = ((amount / total) * 100).toFixed(1);
                        response += `• ${cat}: ${formatCurrency(amount)} (${percent}%)<br>`;
                    });

                return response;
            }

            // Decrease analysis
            if (lowerQ.includes('decrease') || lowerQ.includes('decline') || lowerQ.includes('drop') || lowerQ.includes('lost')) {
                const accountChanges = [];
                latestMonth.accounts.forEach(acc => {
                    const prevAcc = previousMonth.accounts.find(a => a.name === acc.name);
                    if (prevAcc) {
                        const accChange = (acc.gbp_amount || 0) - (prevAcc.gbp_amount || 0);
                        if (accChange < 0) {
                            accountChanges.push({ name: acc.name, change: accChange, category: acc.category });
                        }
                    }
                });

                accountChanges.sort((a, b) => a.change - b.change);

                if (accountChanges.length === 0) {
                    return "Great news! No accounts decreased this month. 📈";
                }

                let response = `<strong>Accounts That Decreased:</strong><br><br>`;
                accountChanges.forEach(acc => {
                    response += `• ${acc.name}: ${formatCurrency(acc.change)} (${acc.category})<br>`;
                });

                return response;
            }

            // Default response
            return `I can help you analyze:<br><br>
                • Net worth changes and contributors<br>
                • Account growth and performance<br>
                • Savings rate trends<br>
                • Asset allocation breakdown<br>
                • Decreases or declines<br><br>
                Try asking something like "What's driving my net worth change?" or "Which accounts grew the most?"`;
        }
    </script>
</body>
</html>
